{% extends "layout.html" %}
{% block content %}

<style>
  /* Elder-friendly chat styling */
  .chat-container {
    height: 650px;
    display: flex;
    flex-direction: column;
    border-radius: 15px;
    overflow: hidden;
  }
  
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 25px;
    background: linear-gradient(135deg, #f8f9fa, #e8f5e9);
    border-radius: 15px;
  }
  
  /* Custom scrollbar for better visibility */
  .chat-messages::-webkit-scrollbar {
    width: 12px;
  }
  
  .chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }
  
  .chat-messages::-webkit-scrollbar-thumb {
    background: #4a7c59;
    border-radius: 10px;
  }
  
  .chat-messages::-webkit-scrollbar-thumb:hover {
    background: #2c6f4f;
  }
  
  .message-item {
    margin-bottom: 20px;
    display: flex;
    align-items: start;
    animation: fadeIn 0.3s ease-in;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .message-item.own-message {
    flex-direction: row-reverse;
  }
  
  .message-content {
    max-width: 70%;
    padding: 15px 20px;
    border-radius: 20px;
    word-wrap: break-word;
    font-size: 1.1rem;
    line-height: 1.5;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .message-item:not(.own-message) .message-content {
    background-color: white;
    border: 2px solid #e8f5e9;
    color: #333;
  }
  
  .message-item.own-message .message-content {
    background: linear-gradient(135deg, #4a7c59, #2c6f4f);
    color: white;
  }
  
  .message-info {
    font-size: 0.9rem;
    color: #6c757d;
    margin: 5px 15px;
    font-weight: 500;
  }
  
  .message-item.own-message .message-info {
    text-align: right;
  }
  
  .participants-sidebar {
    height: 100%;
    overflow-y: auto;
    background: linear-gradient(135deg, #f8f9fa, #fff);
    border-radius: 15px;
    padding: 20px;
  }
  
  .participant-item {
    padding: 12px;
    margin-bottom: 10px;
    background-color: white;
    border-radius: 10px;
    display: flex;
    align-items: center;
    font-size: 1.1rem;
    transition: all 0.3s;
    border: 2px solid transparent;
  }
  
  .participant-item:hover {
    border-color: #4a7c59;
    transform: translateX(5px);
  }
  
  .participant-item.online {
    border-left: 4px solid #28a745;
    background: linear-gradient(90deg, #e8f5e9, white);
  }
  
  .typing-indicator {
    display: none;
    padding: 15px;
    color: #4a7c59;
    font-style: italic;
    font-size: 1rem;
  }
  
  .typing-indicator.active {
    display: block;
    animation: pulse 1.5s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  #messageInput {
    font-size: 1.2rem;
    padding: 15px;
    border: 2px solid #e8f5e9;
    border-radius: 10px;
  }
  
  #messageInput:focus {
    border-color: #4a7c59;
    box-shadow: 0 0 5px rgba(74, 124, 89, 0.3);
  }
  
  .btn-send {
    font-size: 1.2rem;
    padding: 15px 25px;
    background: linear-gradient(135deg, #4a7c59, #2c6f4f);
    border: none;
    color: white;
    border-radius: 10px;
    transition: all 0.3s;
  }
  
  .btn-send:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(74, 124, 89, 0.4);
  }
  
  .chat-header {
    background: linear-gradient(135deg, #4a7c59, #2c6f4f);
    color: white;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 20px;
  }
  
  .chat-header h2 {
    margin: 0;
    font-size: 2rem;
  }
  
  .chat-header p {
    margin: 5px 0 0 0;
    opacity: 0.9;
    font-size: 1.1rem;
  }
</style>

<div class="container-fluid mt-4">
  <div class="chat-header">
    <div class="row align-items-center">
      <div class="col">
        <h2>
          <i class="fas fa-comments"></i> {{ event.title }} - Chat Room
        </h2>
        <p>
          <i class="fas fa-calendar"></i> {{ event.start.strftime('%B %d, %Y') }}
          <span class="ms-3">
            <i class="fas fa-map-marker-alt"></i> {{ event.location }}
          </span>
        </p>
      </div>
      <div class="col-auto">
        <a href="{{ url_for('calendar.event', id=event.id) }}" class="btn btn-light btn-lg">
          <i class="fas fa-arrow-left"></i> Back to Event
        </a>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Chat Messages Area -->
    <div class="col-lg-9 mb-4">
      <div class="card shadow-sm">
        <div class="card-body chat-container">
          <div class="chat-messages" id="chatMessages">
            {% for message in messages %}
            <div class="message-item {% if message.user_id == current_user.id %}own-message{% endif %}" data-message-id="{{ message.id }}">
              <div>
                <div class="message-info">
                  {% if message.user_id != current_user.id %}
                    <strong>{{ message.author.username }}</strong> • 
                  {% endif %}
                  <span class="timestamp">{{ message.timestamp.strftime('%I:%M %p') }}</span>
                </div>
                <div class="message-content">
                  {{ message.content }}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          
          <div class="typing-indicator" id="typingIndicator">
            <i class="fas fa-ellipsis-h"></i> Someone is typing...
          </div>
          
          <!-- Message Input -->
          <div class="mt-3">
            <form id="messageForm" class="d-flex gap-2">
              <input type="text" 
                     id="messageInput" 
                     class="form-control flex-grow-1" 
                     placeholder="Type your message here..." 
                     maxlength="500"
                     autocomplete="off">
              <button type="submit" class="btn btn-send">
                <i class="fas fa-paper-plane"></i> Send
              </button>
            </form>
            <small class="text-muted mt-1 d-block">Press Enter to send, or click the Send button</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Participants Sidebar -->
    <div class="col-lg-3 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0" style="font-size: 1.3rem;">
            <i class="fas fa-users"></i> Participants ({{ participants|length }})
          </h5>
        </div>
        <div class="card-body participants-sidebar">
          {% for participant in participants %}
          <div class="participant-item {% if participant.id == current_user.id %}online{% endif %}">
            <i class="fas fa-user-circle fa-lg me-3 text-success"></i>
            <span class="flex-grow-1">{{ participant.username }}</span>
            {% if participant.id == current_user.id %}
              <span class="badge bg-success" style="font-size: 0.9rem;">You</span>
            {% endif %}
          </div>
          {% endfor %}
          
          {% if not participants %}
          <div class="text-center text-muted py-4">
            <i class="fas fa-user-friends fa-3x mb-3"></i>
            <p>No participants yet</p>
          </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="card shadow-sm mt-3">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0" style="font-size: 1.2rem;">
            <i class="fas fa-info-circle"></i> Chat Tips
          </h5>
        </div>
        <div class="card-body">
          <ul class="list-unstyled" style="font-size: 1rem;">
            <li class="mb-2">
              <i class="fas fa-keyboard text-success"></i> Press <kbd>Enter</kbd> to send
            </li>
            <li class="mb-2">
              <i class="fas fa-sync-alt text-info"></i> Messages update automatically
            </li>
            <li class="mb-2">
              <i class="fas fa-smile text-warning"></i> Be kind and respectful
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let lastMessageId = 0;
  const chatMessages = document.getElementById('chatMessages');
  const messageForm = document.getElementById('messageForm');
  const messageInput = document.getElementById('messageInput');
  const eventId = {{ event.id }};
  
  // Get the last message ID if there are existing messages
  const existingMessages = document.querySelectorAll('.message-item');
  if (existingMessages.length > 0) {
    lastMessageId = parseInt(existingMessages[existingMessages.length - 1].dataset.messageId);
  }
  
  // Auto-scroll to bottom
  function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  
  // Format time
  function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('en-US', { 
      hour: 'numeric', 
      minute: '2-digit',
      hour12: true 
    });
  }
  
  // Add message to chat with animation
  function addMessage(message) {
    const isOwnMessage = message.user_id === {{ current_user.id }};
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-item ${isOwnMessage ? 'own-message' : ''}`;
    messageDiv.dataset.messageId = message.id;
    
    messageDiv.innerHTML = `
      <div>
        <div class="message-info">
          ${!isOwnMessage ? `<strong>${message.username}</strong> • ` : ''}
          <span class="timestamp">${formatTime(message.timestamp)}</span>
        </div>
        <div class="message-content">
          ${escapeHtml(message.content)}
        </div>
      </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
    
    // Play a subtle sound for new messages (optional)
    if (!isOwnMessage) {
      // You can add a subtle notification sound here
    }
  }
  
  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Send message
  messageForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const content = messageInput.value.trim();
    if (!content) return;
    
    // Disable input while sending
    messageInput.disabled = true;
    
    try {
      const response = await fetch(`/event/${eventId}/chat/send`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ content })
      });
      
      if (response.ok) {
        const message = await response.json();
        messageInput.value = '';
        addMessage(message);
        lastMessageId = message.id;
      } else {
        const error = await response.json();
        alert('Error sending message: ' + error.error);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to send message. Please try again.');
    } finally {
      messageInput.disabled = false;
      messageInput.focus();
    }
  });
  
  // Poll for new messages
  async function pollMessages() {
    try {
      const response = await fetch(`/event/${eventId}/chat/messages?last_id=${lastMessageId}`);
      
      if (response.ok) {
        const messages = await response.json();
        messages.forEach(message => {
          if (message.id > lastMessageId) {
            addMessage(message);
            lastMessageId = message.id;
          }
        });
      }
    } catch (error) {
      console.error('Error polling messages:', error);
    }
  }
  
  // Poll every 2 seconds
  setInterval(pollMessages, 2000);
  
  // Initial scroll to bottom
  scrollToBottom();
  
  // Enable Enter key to send
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      messageForm.dispatchEvent(new Event('submit'));
    }
  });
  
  // Focus on input when page loads
  messageInput.focus();
</script>

{% endblock %}