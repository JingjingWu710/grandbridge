{% extends "layout.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
{% endblock %}

{% block content %}

<div class="container-fluid mt-4">
  <div class="chat-header">
    <div class="row align-items-center">
      <div class="col">
        <h2>
          {{ event.title }} - Chat Room
        </h2>
        <p>
          {{ event.start.strftime('%B %d, %Y') }}
          <span class="ms-3">
            {{ event.location }}
          </span>
        </p>
      </div>
      <div class="col-auto">
        <a href="{{ url_for('calendar.event', id=event.id) }}" class="btn btn-light btn-lg">
          Back to Event
        </a>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Chat Messages Area -->
    <div class="col-lg-9 mb-4">
      <div class="card shadow-sm">
        <div class="card-body chat-container">
          <div class="chat-messages" id="chatMessages">
            {% for message in messages %}
            <div class="message-item {% if message.user_id == current_user.id %}own-message{% endif %}" data-message-id="{{ message.id }}">
              <div>
                <div class="message-info">
                  {% if message.user_id != current_user.id %}
                    <strong>{{ message.author.username }}</strong> • 
                  {% endif %}
                  <span class="timestamp">{{ message.timestamp.strftime('%I:%M %p') }}</span>
                </div>
                <div class="message-content">
                  {{ message.content }}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          
          <div class="typing-indicator" id="typingIndicator" style="display: none;">
            Someone is typing...
          </div>
          
          <!-- Message Input -->
          <div class="mt-3">
            <form id="messageForm" class="d-flex gap-2">
              <input type="text" 
                     id="messageInput" 
                     class="form-control flex-grow-1" 
                     placeholder="Type your message here..." 
                     maxlength="500"
                     autocomplete="off">
              <button type="submit" class="btn btn-send">
                Send
              </button>
            </form>
            <small class="text-muted mt-1 d-block">Press Enter to send, or click the Send button</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Participants Sidebar -->
    <div class="col-lg-3 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0" style="font-size: 1.3rem;">
            Participants ({{ participants|length }})
          </h5>
        </div>
        <div class="card-body participants-sidebar">
          {% for participant in participants %}
          <div class="participant-item {% if participant.id == current_user.id %}online{% endif %}">
            <span class="flex-grow-1">{{ participant.username }}</span>
            {% if participant.id == current_user.id %}
              <span class="badge bg-success" style="font-size: 0.9rem;">You</span>
            {% endif %}
          </div>
          {% endfor %}
          
          {% if not participants %}
          <div class="text-center text-muted py-4">
            <p>No participants yet</p>
          </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="card shadow-sm mt-3">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0" style="font-size: 1.2rem;">
            Chat Tips
          </h5>
        </div>
        <div class="card-body">
          <ul class="list-unstyled" style="font-size: 1rem;">
            <li class="mb-2">
              <i class="fas fa-keyboard text-success"></i> Press <kbd>Enter</kbd> to send
            </li>
            <li class="mb-2">
              <i class="fas fa-sync-alt text-info"></i> Messages update automatically
            </li>
            <li class="mb-2">
              <i class="fas fa-smile text-warning"></i> Be kind and respectful
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script defer>
document.addEventListener('DOMContentLoaded', function() {
  let lastMessageId = 0;
  const chatMessages = document.getElementById('chatMessages');
  const messageForm = document.getElementById('messageForm');
  const messageInput = document.getElementById('messageInput');
  const eventId = {{ event.id }};
  
  // Get the last message ID if there are existing messages
  const existingMessages = document.querySelectorAll('.message-item');
  if (existingMessages.length > 0) {
    lastMessageId = parseInt(existingMessages[existingMessages.length - 1].dataset.messageId);
  }
  
  // Auto-scroll to bottom
  function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  
  // Format time
  function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('en-US', { 
      hour: 'numeric', 
      minute: '2-digit',
      hour12: true 
    });
  }
  
  // Add message to chat with animation
  function addMessage(message) {
    const isOwnMessage = message.user_id === {{ current_user.id }};
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-item ${isOwnMessage ? 'own-message' : ''}`;
    messageDiv.dataset.messageId = message.id;
    
    messageDiv.innerHTML = `
      <div>
        <div class="message-info">
          ${!isOwnMessage ? `<strong>${message.username}</strong> • ` : ''}
          <span class="timestamp">${formatTime(message.timestamp)}</span>
        </div>
        <div class="message-content">
          ${escapeHtml(message.content)}
        </div>
      </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
  }
  
  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Send message
  messageForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const content = messageInput.value.trim();
    if (!content) return;
    
    // Disable input while sending
    messageInput.disabled = true;
    
    try {
      const response = await fetch(`/event/${eventId}/chat/send`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ content })
      });
      
      if (response.ok) {
        const message = await response.json();
        messageInput.value = '';
        addMessage(message);
        lastMessageId = message.id;
      } else {
        const error = await response.json();
        alert('Error sending message: ' + error.error);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to send message. Please try again.');
    } finally {
      messageInput.disabled = false;
      messageInput.focus();
    }
  });
  
  // Poll for new messages - delay start to allow LCP to complete
  async function pollMessages() {
    try {
      const response = await fetch(`/event/${eventId}/chat/messages?last_id=${lastMessageId}`);
      
      if (response.ok) {
        const messages = await response.json();
        messages.forEach(message => {
          if (message.id > lastMessageId) {
            addMessage(message);
            lastMessageId = message.id;
          }
        });
      }
    } catch (error) {
      console.error('Error polling messages:', error);
    }
  }
  
  // Delay polling to allow LCP to complete first
  setTimeout(() => {
    setInterval(pollMessages, 2000);
  }, 2000);
  
  // Initial scroll to bottom
  scrollToBottom();
  
  // Enable Enter key to send
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      messageForm.dispatchEvent(new Event('submit'));
    }
  });
  
  // Delay focus to prevent blocking LCP
  setTimeout(() => {
    messageInput.focus();
  }, 500);
});
</script>

{% endblock %}