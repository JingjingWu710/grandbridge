{% extends "layout.html" %} 
{% block content %}
<br />
<h1>{{ current_user.username }}</h1>
<h3>{{ current_user.email }}</h3>

<div class="content-section">
  <form method="POST" action="" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    <fieldset class="form-group">
        {% if current_user.is_admin %}
        <legend class="border-bottom mb-4">Admin Account Info</legend>
        {% else %}
      <legend class="border-bottom mb-4">Account Info</legend>
      {% endif %}
      
      <div class="form-group">
        {{ form.username.label(class="form-control-label") }} 
        {% if form.username.errors %} 
          {{ form.username(class="form-control form-control-lg is-invalid") }}
          <div class="invalid-feedback">
            {% for error in form.username.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
        {% else %} 
          {{ form.username(class="form-control form-control-lg") }} 
        {% endif %}
      </div>
      
      <div class="form-group">
        {{ form.email.label(class="form-control-label") }} 
        {% if form.email.errors %} 
          {{ form.email(class="form-control form-control-lg is-invalid") }}
          <div class="invalid-feedback">
            {% for error in form.email.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
        {% else %} 
          {{ form.email(class="form-control form-control-lg") }} 
        {% endif %}
      </div>
      
      {% if not current_user.is_admin %}
      <div class="form-group">
        {{ form.family_id.label(class="form-control-label") }}
        {% if form.family_id.errors %}
            {{ form.family_id(class="form-control form-control-lg is-invalid") }}
            <div class="invalid-feedback">
                {% for error in form.family_id.errors %}
                    <span>{{ error }}</span>
                {% endfor %}
            </div>
        {% else %}
            {{ form.family_id(class="form-control form-control-lg") }}
        {% endif %}
      </div>

      <div class="form-group">
        {{ form.address.label(class="form-control-label") }} 
        {% if form.address.errors %} 
          {{ form.address(class="form-control form-control-lg is-invalid") }}
          <div class="invalid-feedback">
            {% for error in form.address.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
        {% else %} 
          {{ form.address(class="form-control form-control-lg") }} 
        {% endif %}
      </div>
      
      <div class="form-group">
        {{ form.contact_info.label(class="form-control-label") }} 
        {% if form.contact_info.errors %} 
          {{ form.contact_info(class="form-control form-control-lg is-invalid") }}
          <div class="invalid-feedback">
            {% for error in form.contact_info.errors %}
            <span>{{ error }}</span>
            {% endfor %}
          </div>
        {% else %} 
          {{ form.contact_info(class="form-control form-control-lg") }} 
        {% endif %}
      </div>
      {% endif %}
    </fieldset>
    
    <div class="form-group">
      {{ form.submit(class="btn btn-outline-info") }}
      {% if current_user.is_admin %}
      <a href="{{ url_for('users.create_family') }}" class="btn btn-outline-info">Add Family</a>
      {% endif %}
    </div>
  </form>
  
  <!-- Family Information Section for Normal Users -->
  {% if not current_user.is_admin and family_info %}
  <div class="content-section mt-4">
    <fieldset class="form-group">
      <legend class="border-bottom mb-4">Family Information</legend>
      
      <div class="mb-3">
        <h5>Family: {{ family_info.family.name }} (ID: {{ family_info.family.id }})</h5>
      </div>
      
      <!-- Family Members Section -->
      <div class="mb-4">
        <h6 class="text-info">Family Members:</h6>
        {% if family_info.members %}
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead class="thead-light">
                <tr>
                  <th>Username</th>
                  <th>Address</th>
                  <th>Contact Info</th>
                </tr>
              </thead>
              <tbody>
                {% for member in family_info.members %}
                <tr {% if member.id == current_user.id %}class="table-primary"{% endif %}>
                  <td>
                    {{ member.username }}
                    {% if member.id == current_user.id %}<small class="text-muted">(You)</small>{% endif %}
                  </td>
                  <td>{{ member.address or '-' }}</td>
                  <td>{{ member.contact_info or '-' }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">No family members found.</p>
        {% endif %}
      </div>
      
      <!-- Family Admins Section -->
      <div class="mb-3">
        <h6 class="text-info">Community Administrators for Your Family:</h6>
        {% if family_info.admins %}
          <ul class="list-group">
            {% for admin in family_info.admins %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ admin.username }}</strong>
                <small class="text-muted d-block">{{ admin.email }}</small>
              </div>
              <span class="badge badge-primary badge-pill">Admin</span>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No administrators assigned to this family.</p>
        {% endif %}
      </div>
    </fieldset>
  </div>
  {% elif not current_user.is_admin and not family_info %}
  <div class="content-section mt-4">
    <div class="alert alert-info">
      <strong>No Family Information</strong><br>
      You are not currently a member of any family. Enter a Family ID above to join an existing family or leave it blank to create a new one.
    </div>
  </div>
  {% endif %}
  
  <form
    action="{{ url_for('users.delete_account') }}"
    method="POST"
    onsubmit="return confirm('Are you sure you want to delete your account?');"
    class="mt-3"
  >
    <button type="submit" class="btn btn-danger">Delete this account</button>
  </form>
</div>
{% endblock content %}