{% extends "layout.html" %} 
{% block content %}

<style>
  /* Elder-friendly events list styling */
  .events-header {
    background: linear-gradient(135deg, #4a7c59, #2c6f4f);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }
  
  .events-header h1 {
    font-size: 2.5rem;
    margin: 0;
  }
  
  .events-header p {
    font-size: 1.3rem;
    margin-top: 10px;
    opacity: 0.9;
  }
  
  .event-card {
    border: 2px solid #e8f5e9;
    border-radius: 15px;
    padding: 0;
    margin-bottom: 25px;
    transition: all 0.3s;
    overflow: hidden;
    background: white;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  }
  
  .event-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    border-color: #4a7c59;
  }
  
  .event-card-header {
    background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
    padding: 20px;
    border-bottom: 2px solid #e8f5e9;
  }
  
  .event-card-header h3 {
    font-size: 1.8rem;
    color: #2c6f4f;
    margin: 0;
    display: flex;
    align-items: center;
  }
  
  .event-card-header h3 i {
    margin-right: 15px;
    color: #4a7c59;
  }
  
  .event-card-body {
    padding: 25px;
  }
  
  .event-info-item {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    font-size: 1.2rem;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 10px;
    transition: all 0.3s;
  }
  
  .event-info-item:hover {
    background: #e8f5e9;
    transform: translateX(5px);
  }
  
  .event-info-item i {
    color: #4a7c59;
    margin-right: 15px;
    font-size: 1.3rem;
    width: 30px;
    text-align: center;
  }
  
  .event-info-label {
    font-weight: bold;
    color: #495057;
    margin-right: 10px;
  }
  
  .event-actions {
    padding: 20px;
    background: #f8f9fa;
    border-top: 2px solid #e8f5e9;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .event-actions .btn {
    font-size: 1.1rem;
    padding: 12px 20px;
    border-radius: 10px;
    transition: all 0.3s;
  }
  
  .event-actions .btn:hover {
    transform: scale(1.05);
  }
  
  .participant-count {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 1rem;
    margin-left: auto;
  }
  
  .participant-count i {
    margin-right: 8px;
  }
  
  .no-events {
    text-align: center;
    padding: 60px 20px;
    background: linear-gradient(135deg, #f8f9fa, #e8f5e9);
    border-radius: 15px;
    margin: 30px 0;
  }
  
  .no-events i {
    font-size: 5rem;
    color: #4a7c59;
    margin-bottom: 20px;
  }
  
  .no-events h3 {
    font-size: 2rem;
    color: #495057;
    margin-bottom: 15px;
  }
  
  .no-events p {
    font-size: 1.3rem;
    color: #6c757d;
    margin-bottom: 25px;
  }
  
  .filter-section {
    background: white;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 30px;
    border: 2px solid #e8f5e9;
  }
  
  .filter-section h4 {
    color: #2c6f4f;
    margin-bottom: 15px;
    font-size: 1.5rem;
  }
  
  .badge-status {
    font-size: 1rem;
    padding: 8px 12px;
    border-radius: 8px;
    margin-left: 10px;
  }
  
  .event-description {
    background: #fff3e0;
    padding: 15px;
    border-radius: 10px;
    margin-top: 15px;
    font-size: 1.1rem;
    line-height: 1.6;
    border-left: 4px solid #ff9800;
  }
  
  .date-navigation {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .date-navigation .btn {
    font-size: 1.2rem;
    padding: 12px 25px;
  }
  
  .current-date {
    font-size: 1.4rem;
    font-weight: bold;
    color: #2c6f4f;
    padding: 10px 20px;
    background: #e8f5e9;
    border-radius: 10px;
  }
  
  .event-card.hidden {
    display: none;
  }
  
  .event-card.highlight {
    border-color: #ffc107;
    box-shadow: 0 0 20px rgba(255, 193, 7, 0.3);
  }
  
  .no-filtered-events {
    text-align: center;
    padding: 30px;
    background: #f8f9fa;
    border-radius: 15px;
    margin-top: 20px;
  }
  
  .starting-soon-badge {
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }
</style>

<div class="container mt-4">
  <!-- Header Section -->
  <div class="events-header">
    <h1>
      <i class="fas fa-calendar-day"></i> Events for {{ selected_date|default("Today") }}
    </h1>
    <p>View and manage all scheduled events</p>
  </div>

  <!-- Date Navigation (if applicable) -->
  {% if show_date_nav %}
  <div class="date-navigation">
    <a href="?date={{ prev_date }}" class="btn btn-outline-secondary">
      <i class="fas fa-chevron-left"></i> Previous Day
    </a>
    <span class="current-date">
      <i class="fas fa-calendar"></i> {{ selected_date }}
    </span>
    <a href="?date={{ next_date }}" class="btn btn-outline-secondary">
      <i class="fas fa-chevron-right"></i> Next Day
    </a>
  </div>
  {% endif %}

  <!-- Filter Section (optional) -->
  {% if current_user.is_admin %}
  <div class="filter-section">
    <h4><i class="fas fa-filter"></i> Quick Filters</h4>
    <div class="btn-group" role="group">
      <button class="btn btn-outline-success active" onclick="filterEvents('all', event)">
        <i class="fas fa-list"></i> All Events
      </button>
      <button class="btn btn-outline-info" onclick="filterEvents('participating', event)">
        <i class="fas fa-user-check"></i> Participating
      </button>
      <button class="btn btn-outline-warning" onclick="filterEvents('upcoming', event)">
        <i class="fas fa-clock"></i> Upcoming
      </button>
    </div>
  </div>
  {% endif %}

  <!-- Events List -->
  {% if events %}
    {% for event in events %}
    <div class="event-card" 
         data-event-id="{{ event.id }}"
         data-participating="{{ 'true' if event.is_participant(current_user) else 'false' }}"
         data-start-time="{{ event.start.isoformat() }}">
      <div class="event-card-header">
        <div class="d-flex align-items-center">
          <h3 class="flex-grow-1">
            <i class="fas fa-calendar-check"></i>
            {{ event.title }}
          </h3>
          {% if event.participants.count() > 0 %}
          <span class="participant-count">
            <i class="fas fa-users"></i>
            {{ event.participants.count() }} Participant(s)
          </span>
          {% endif %}
        </div>
      </div>
      
      <div class="event-card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="event-info-item">
              <i class="fas fa-clock"></i>
              <span class="event-info-label">Time:</span>
              {{ event.start.strftime('%I:%M %p') }} - {{ event.end.strftime('%I:%M %p') }}
            </div>
          </div>
          <div class="col-md-6">
            <div class="event-info-item">
              <i class="fas fa-map-marker-alt"></i>
              <span class="event-info-label">Location:</span>
              {{ event.location }}
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="event-info-item">
              <i class="fas fa-calendar"></i>
              <span class="event-info-label">Date:</span>
              {{ event.start.strftime('%B %d, %Y') }}
            </div>
          </div>
          <div class="col-md-6">
            <div class="event-info-item">
              <i class="fas fa-hourglass-half"></i>
              <span class="event-info-label">Duration:</span>
              {% set duration = event.end - event.start %}
              {% if duration.seconds // 3600 > 0 %}
                {{ duration.seconds // 3600 }}h {{ (duration.seconds % 3600) // 60 }}m
              {% else %}
                {{ (duration.seconds % 3600) // 60 }} minutes
              {% endif %}
            </div>
          </div>
        </div>
        
        {% if event.description %}
        <div class="event-description">
          <i class="fas fa-info-circle"></i> {{ event.description }}
        </div>
        {% endif %}
        
        <!-- Participation Status -->
        {% if current_user.is_authenticated %}
          {% if event.is_participant(current_user) %}
          <span class="badge bg-success badge-status">
            <i class="fas fa-check-circle"></i> You're Participating
          </span>
          {% elif event.can_participate(current_user) %}
          <span class="badge bg-info badge-status">
            <i class="fas fa-info-circle"></i> You Can Join
          </span>
          {% endif %}
        {% endif %}
      </div>
      
      <div class="event-actions">
        <a href="{{ url_for('calendar.event', id=event.id) }}" class="btn btn-primary">
          <i class="fas fa-eye"></i> View Details
        </a>
        
        {% if current_user.is_authenticated and event.can_participate(current_user) %}
          {% if event.is_participant(current_user) %}
            <a href="{{ url_for('chatroom.event_chat', id=event.id) }}" class="btn btn-info">
              <i class="fas fa-comments"></i> Chat Room
            </a>
            <form action="{{ url_for('chatroom.toggle_participation', id=event.id) }}" method="POST" class="d-inline">
              <button type="submit" class="btn btn-warning">
                <i class="fas fa-user-minus"></i> Leave Event
              </button>
            </form>
          {% else %}
            <form action="{{ url_for('chatroom.toggle_participation', id=event.id) }}" method="POST" class="d-inline">
              <button type="submit" class="btn btn-success">
                <i class="fas fa-user-plus"></i> Join Event
              </button>
            </form>
          {% endif %}
        {% endif %}
        
        {% if current_user.is_admin %}
          <a href="{{ url_for('calendar.edit_event', id=event.id) }}" class="btn btn-outline-primary">
            <i class="fas fa-edit"></i> Edit
          </a>
          <button class="btn btn-outline-danger" onclick="confirmDelete({{ event.id }}, '{{ event.title }}')">
            <i class="fas fa-trash"></i> Delete
          </button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="no-events">
      <i class="fas fa-calendar-times"></i>
      <h3>No Events Scheduled</h3>
      <p>There are no events scheduled for this date.</p>
      {% if current_user.is_admin %}
        <a href="{{ url_for('calendar.new_event') }}" class="btn btn-success btn-lg">
          <i class="fas fa-plus-circle"></i> Create New Event
        </a>
      {% endif %}
    </div>
  {% endif %}

  <!-- Navigation Buttons -->
  <div class="text-center mt-5">
    <a href="{{ url_for('calendar.calendar_view') }}" class="btn btn-outline-secondary btn-lg">
      <i class="fas fa-calendar-alt"></i> Back to Calendar
    </a>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle"></i> Confirm Delete
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <i class="fas fa-trash-alt fa-4x text-danger mb-3"></i>
        <p class="fs-5">Are you sure you want to delete "<span id="deleteEventTitle"></span>"?</p>
        <p class="text-danger">This action cannot be undone!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="POST" class="d-inline">
          <button type="submit" class="btn btn-danger">Delete Event</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Filter events function
  function filterEvents(type, event) {
    const eventCards = document.querySelectorAll('.event-card');
    const filterButtons = document.querySelectorAll('.filter-section .btn');
    
    // Update active button
    filterButtons.forEach(btn => btn.classList.remove('active'));
    if (event && event.target) {
      event.target.classList.add('active');
    }
    
    eventCards.forEach(card => {
      card.classList.remove('hidden', 'highlight');
      
      switch(type) {
        case 'all':
          // Show all events
          card.classList.remove('hidden');
          break;
          
        case 'participating':
          // Show only events user is participating in
          if (card.dataset.participating !== 'true') {
            card.classList.add('hidden');
          } else {
            card.classList.add('highlight');
          }
          break;
          
        case 'upcoming':
          // Show only future events
          const eventTime = new Date(card.dataset.startTime);
          const now = new Date();
          if (eventTime < now) {
            card.classList.add('hidden');
          } else {
            card.classList.add('highlight');
          }
          break;
      }
    });
    

  
  // Delete confirmation
  function confirmDelete(eventId, eventTitle) {
    document.getElementById('deleteEventTitle').textContent = eventTitle;
    document.getElementById('deleteForm').action = `/calendar/event/${eventId}/delete`;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
  }
  
  // Add hover effects and initialize features
  document.addEventListener('DOMContentLoaded', function() {
    const eventCards = document.querySelectorAll('.event-card');
    
    // Add hover effects
    eventCards.forEach(card => {
      card.addEventListener('mouseenter', function() {
        if (!this.classList.contains('hidden')) {
          this.style.transform = 'translateY(-5px)';
        }
      });
      
      card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0)';
      });
    });
    
    // Auto-highlight upcoming events within 1 hour
    const now = new Date();
    eventCards.forEach(card => {
      const eventTime = new Date(card.dataset.startTime);
      const timeDiff = eventTime - now;
      const oneHour = 60 * 60 * 1000;
      
      if (timeDiff > 0 && timeDiff <= oneHour) {
        // Event starts within the next hour
        const badge = document.createElement('span');
        badge.className = 'badge bg-warning text-dark position-absolute top-0 end-0 m-2 starting-soon-badge';
        badge.innerHTML = '<i class="fas fa-bell"></i> Starting Soon';
        card.style.position = 'relative';
        card.appendChild(badge);
      }
    });
  });
  
  
</script>

{% endblock %}