<!--breathing_exercise-->
{% extends "layout.html" %}
{% block content %}
<style>
    .breathing-container {
        text-align: center;
        padding: 40px 20px;
        max-width: 800px;
        margin: 0 auto;
    }
    
    .breathing-circle {
        width: 250px;
        height: 250px;
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        border-radius: 50%;
        margin: 40px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        font-weight: bold;
        color: #2c6f4f;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        transition: all 4s ease-in-out;
        border: 5px solid #4a7c59;
    }
    
    .breathing-circle.inhale {
        transform: scale(1.3);
        background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    }
    
    .breathing-circle.hold {
        transform: scale(1.3);
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    }
    
    .breathing-circle.exhale {
        transform: scale(0.8);
        background: linear-gradient(135deg, #fce4ec, #f8bbd0);
    }
    
    .instruction-text {
        font-size: 24px;
        color: #555;
        margin: 20px 0;
        min-height: 40px;
    }
    
    .countdown {
        font-size: 48px;
        font-weight: bold;
        color: #2c6f4f;
        margin: 20px 0;
        min-height: 60px;
    }
    
    .progress-bar-container {
        background: #e0e0e0;
        border-radius: 25px;
        height: 30px;
        margin: 30px auto;
        max-width: 500px;
        overflow: hidden;
    }
    
    .progress-bar-fill {
        background: linear-gradient(90deg, #4a7c59, #2c6f4f);
        height: 100%;
        width: 0%;
        transition: width 1s linear;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }
    
    .control-buttons {
        margin: 30px 0;
    }
    
    .btn-breathing {
        font-size: 20px;
        padding: 15px 40px;
        margin: 10px;
        border-radius: 25px;
    }
    
    .stats-row {
        display: flex;
        justify-content: space-around;
        margin: 30px 0;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 15px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-number {
        font-size: 32px;
        font-weight: bold;
        color: #2c6f4f;
    }
    
    .stat-label {
        font-size: 16px;
        color: #666;
        margin-top: 5px;
    }
</style>

<div class="breathing-container">
    <h1>üå¨Ô∏è 4-7-8 Breathing Exercise</h1>
    <p class="lead">This technique helps reduce anxiety and promotes relaxation</p>
    
    <!-- Stats Display -->
    <div class="stats-row">
        <div class="stat-item">
            <div class="stat-number" id="cycleCount">0</div>
            <div class="stat-label">Cycles Completed</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="totalTime">0:00</div>
            <div class="stat-label">Total Time</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="targetCycles">4</div>
            <div class="stat-label">Target Cycles</div>
        </div>
    </div>
    
    <!-- Breathing Circle -->
    <div class="breathing-circle" id="breathingCircle">
        <span id="circleText">Ready</span>
    </div>
    
    <!-- Countdown Display -->
    <div class="countdown" id="countdown"></div>
    
    <!-- Instruction Text -->
    <div class="instruction-text" id="instruction">
        Click "Start" to begin your breathing exercise
    </div>
    
    <!-- Progress Bar -->
    <div class="progress-bar-container">
        <div class="progress-bar-fill" id="progressBar">0%</div>
    </div>
    
    <!-- Control Buttons -->
    <div class="control-buttons">
        <button class="btn btn-success btn-breathing" id="startBtn" onclick="startExercise()">
            ‚ñ∂Ô∏è Start Exercise
        </button>
        <button class="btn btn-warning btn-breathing" id="pauseBtn" onclick="pauseExercise()" style="display: none;">
            ‚è∏Ô∏è Pause
        </button>
        <button class="btn btn-danger btn-breathing" id="stopBtn" onclick="stopExercise()" style="display: none;">
            ‚èπÔ∏è Stop
        </button>
    </div>
    
    <!-- Completion Form (hidden initially) -->
    <div id="completionForm" style="display: none;">
        <div class="alert alert-success" style="font-size: 20px; margin-top: 30px;">
            <h3>üéâ Excellent Work!</h3>
            <p>You've completed the breathing exercise!</p>
        </div>
        
        <form method="POST" action="{{ url_for('planting.complete_mindfulness', activity_type='breathing', activity_id='478') }}">
            <div class="form-group">
                <label style="font-size: 20px;">How do you feel now?</label>
                <div class="d-flex justify-content-center mt-3">
                    <label class="mx-2">
                        <input type="radio" name="mood_after" value="1" required>
                        <span style="font-size: 30px;">üòî</span>
                    </label>
                    <label class="mx-2">
                        <input type="radio" name="mood_after" value="2">
                        <span style="font-size: 30px;">üòü</span>
                    </label>
                    <label class="mx-2">
                        <input type="radio" name="mood_after" value="3">
                        <span style="font-size: 30px;">üòê</span>
                    </label>
                    <label class="mx-2">
                        <input type="radio" name="mood_after" value="4">
                        <span style="font-size: 30px;">üôÇ</span>
                    </label>
                    <label class="mx-2">
                        <input type="radio" name="mood_after" value="5">
                        <span style="font-size: 30px;">üòä</span>
                    </label>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary btn-lg mt-3">
                Complete & Earn 5 Coins
            </button>
        </form>
    </div>
    
    <!-- Tips Section -->
    <div class="alert alert-info mt-4" style="font-size: 18px;">
        <h4>üí° Tips for Success:</h4>
        <ul style="text-align: left;">
            <li>Find a comfortable seated position</li>
            <li>Place one hand on your chest and one on your belly</li>
            <li>Breathe in quietly through your nose</li>
            <li>Exhale completely through your mouth, making a whoosh sound</li>
            <li>If you feel dizzy, return to normal breathing</li>
        </ul>
    </div>
</div>

<script>
    let exerciseInterval;
    let currentPhase = 'ready';
    let cyclesCompleted = 0;
    let totalSeconds = 0;
    let isPaused = false;
    let phaseTimeLeft = 0;
    let totalTimeInterval;
    
    const targetCycles = 4;
    const phases = [
        { name: 'inhale', duration: 4, text: 'Breathe In', instruction: 'Inhale slowly through your nose' },
        { name: 'hold', duration: 7, text: 'Hold', instruction: 'Hold your breath gently' },
        { name: 'exhale', duration: 8, text: 'Breathe Out', instruction: 'Exhale completely through your mouth' }
    ];
    
    function startExercise() {
        if (isPaused) {
            resumeExercise();
            return;
        }
        
        cyclesCompleted = 0;
        totalSeconds = 0;
        updateDisplay();
        
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('pauseBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').style.display = 'inline-block';
        document.getElementById('completionForm').style.display = 'none';
        
        // Start total time counter
        totalTimeInterval = setInterval(() => {
            totalSeconds++;
            updateTotalTime();
        }, 1000);
        
        runCycle();
    }
    
    function runCycle() {
        if (cyclesCompleted >= targetCycles) {
            completeExercise();
            return;
        }
        
        let phaseIndex = 0;
        
        function runPhase() {
            if (isPaused) return;
            
            if (phaseIndex >= phases.length) {
                cyclesCompleted++;
                updateDisplay();
                if (cyclesCompleted < targetCycles) {
                    phaseIndex = 0;
                    runPhase();
                } else {
                    completeExercise();
                }
                return;
            }
            
            const phase = phases[phaseIndex];
            currentPhase = phase.name;
            phaseTimeLeft = phase.duration;
            
            const circle = document.getElementById('breathingCircle');
            circle.className = 'breathing-circle ' + phase.name;
            document.getElementById('circleText').textContent = phase.text;
            document.getElementById('instruction').textContent = phase.instruction;
            
            const countdownInterval = setInterval(() => {
                if (isPaused) {
                    clearInterval(countdownInterval);
                    return;
                }
                
                if (phaseTimeLeft > 0) {
                    document.getElementById('countdown').textContent = phaseTimeLeft;
                    phaseTimeLeft--;
                } else {
                    clearInterval(countdownInterval);
                    phaseIndex++;
                    runPhase();
                }
            }, 1000);
        }
        
        runPhase();
    }
    
    function pauseExercise() {
        isPaused = true;
        clearInterval(totalTimeInterval);
        document.getElementById('pauseBtn').textContent = '‚ñ∂Ô∏è Resume';
        document.getElementById('pauseBtn').onclick = resumeExercise;
        document.getElementById('instruction').textContent = 'Exercise paused - click Resume to continue';
    }
    
    function resumeExercise() {
        isPaused = false;
        document.getElementById('pauseBtn').textContent = '‚è∏Ô∏è Pause';
        document.getElementById('pauseBtn').onclick = pauseExercise;
        
        totalTimeInterval = setInterval(() => {
            totalSeconds++;
            updateTotalTime();
        }, 1000);
        
        runCycle();
    }
    
    function stopExercise() {
        isPaused = false;
        clearInterval(totalTimeInterval);
        
        const circle = document.getElementById('breathingCircle');
        circle.className = 'breathing-circle';
        document.getElementById('circleText').textContent = 'Stopped';
        document.getElementById('countdown').textContent = '';
        document.getElementById('instruction').textContent = 'Exercise stopped - click Start to begin again';
        
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('pauseBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'none';
        
        cyclesCompleted = 0;
        totalSeconds = 0;
        updateDisplay();
    }
    
    function completeExercise() {
        clearInterval(totalTimeInterval);
        
        const circle = document.getElementById('breathingCircle');
        circle.className = 'breathing-circle';
        document.getElementById('circleText').textContent = '‚ú® Complete!';
        document.getElementById('countdown').textContent = '';
        document.getElementById('instruction').textContent = 'Wonderful job! You completed all cycles.';
        
        document.getElementById('pauseBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('completionForm').style.display = 'block';
        
        // Show achievement animation
        circle.style.animation = 'pulse 1s ease-in-out 3';
    }
    
    function updateDisplay() {
        document.getElementById('cycleCount').textContent = cyclesCompleted;
        updateProgressBar();
    }
    
    function updateTotalTime() {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        document.getElementById('totalTime').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function updateProgressBar() {
        const percentage = (cyclesCompleted / targetCycles) * 100;
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = percentage + '%';
        progressBar.textContent = Math.round(percentage) + '%';
    }
</script>

<style>
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}